<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>紫煙くゆる生物室</title>
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f12">
<style>
  :root { --bg:#0f0f12; --fg:#e8e8ee; --muted:#9aa0a6; --accent:#bca0ff; --card:#17171b; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic UI","Yu Gothic","Meiryo",sans-serif;
            min-height:100dvh;}
  .wrap{display:flex;flex-direction:column;gap:12px;padding:16px;max-width:960px;margin:0 auto; box-sizing:border-box}
  .stage{position:relative;border-radius:16px;background:linear-gradient(180deg,#1a1a22,#0d0d10);min-height:58dvh;
         display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.05)}
  .char{position:relative;width:min(520px,92vw);aspect-ratio:3/5;background:#111;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;touch-action:manipulation}
  .layer{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none}
  .overlay{position:absolute;inset:auto 12px 12px 12px;background:rgba(20,20,26,.7);color:var(--fg);
           border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;font-size:15px;line-height:1.6;backdrop-filter:blur(6px)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--card);color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;font-size:14px}
  button:active{transform:translateY(1px)}
  .hidden{display:none}
  .settings-btn{position:fixed;right:16px;bottom:16px;width:52px;height:52px;border-radius:50%;
                display:flex;align-items:center;justify-content:center;font-size:24px;background:rgba(0,0,0,.6);
                border:1px solid rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.4); z-index:10;}
  .settings-menu{position:fixed;right:16px;bottom:76px;min-width:200px;background:rgba(18,18,22,.95);
                 border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;display:none; z-index:10;}
  .settings-menu .item{display:block;width:100%;text-align:left;border:none;background:transparent;
                       padding:10px;border-radius:8px;font-size:14px}
  .settings-menu .item:hover{background:rgba(255,255,255,.06)}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <div class="char" id="char" title="タップでセリフ切替">
      <img id="img-base"  class="layer" alt="base"  src="base.png"  onerror="this.style.display='none'"/>
      <img id="img-smile" class="layer" alt="smile" src="smile.png" style="display:none" onerror="this.style.display='none'"/>
    </div>
    <div class="overlay" id="bubble">……おや、来てくれたのですね。</div>
  </div>

  <div class="toolbar" id="toolbar">
    <button id="btn-rand">セリフ（ランダム）</button>
    <button id="btn-greet">時間の挨拶</button>
    <button id="btn-mood">微笑 ON/OFF</button>
    <button id="btn-full">全画面</button>
  </div>
</div>

<button class="settings-btn" id="settings-btn" aria-label="設定">⚙</button>
<div class="settings-menu" id="settings-menu">
  <button class="item" id="menu-full">全画面 ON/OFF</button>
  <button class="item" id="menu-ui">UI 表示/非表示</button>
  <button class="item" id="menu-reload">再読み込み</button>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const imgBase=$('img-base'), imgSmile=$('img-smile');
  const bubble=$('bubble');

  const state = { mood:false };

  function sync(){
    imgSmile.style.display = state.mood && imgSmile.getAttribute('src') ? 'block' : 'none';
  }
  function setBubble(t){ bubble.textContent=t; }
  function pick(a){ return a[Math.floor(Math.random()*a.length)]; }

  const timeGreetings={
     nightLate:[
        "まだ起きているのですか……ええ、実は私もです。",
        "夜更けに呼吸を合わせると、不思議と落ち着きますね。"
      ],
      morning:[
        "おはようございます。朝の光は、体内時計の薬です。",
        "あなたは朝から元気ですね。……素晴らしいことです。ええ、ずっと見守っていたいです。",
        "……おや。睡眠不足ですか？ 私も人のことを言えませんがね。"
      ],
      noon:[
        "午後の光は気怠いですね……少し肩の力を抜きましょう。",
        "午前中頑張りましたね。一服しましょう。",
        "お昼は食べましたか。眠たいのなら、少しだけ陽を浴びてください。",
        "姉さん……桃は魅力的なひとでしょう。それに比べ、あなたがなぜ私のところへ来るのかわかりかねますが……ふふ。うれしいですよ。",
        "仕事……いいんですよ。あなたのためなら私はいくらでも時間を作ります。"
      ],
      evening:[
        "こんにちは。……肩に力が入りすぎていませんか。私と一緒にゆっくり呼吸をしましょう……。",
        "おやつ、食べますか？ チョコミントアイス……お好きなら、半分こしましょう。",
        "空の色が変わる時間……あなたと見るのが好きです。",
        "あなたは頑張り屋さんなんですから、自覚して休憩しないといけませんよ……。必要なら、私がお茶を淹れます。"
      ],
      night:[
        "夜風にあたりながら遠い空をぼうっと見つめると……一日のざわめきも死んだように静まります。",
        "あの……今夜、眠る前にすこし撫でていただけませんか。……そうしたら、眠れる気がします。",
        "お疲れ様です。家に帰ったら、あなたはもう安心していいのですよ。私がついていますから……。",
        "こんばんは。今日もよく来ましたね。どうぞ一息ついてください。"
      ]
  };

  const baseLines=[
    "……おや、来てくれたのですね。",
    "待たせてしまいましたね。",
    "静かな夜です。あなたも、息をひとつ。",
    "目を閉じて。……大丈夫、ここにいます。",
    "ふふ、そんな顔をするのですね。……可愛らしい。",
    "呼吸を整えて。—はい、今ので少し楽になったでしょう。"
  ];

  function timeGreeting(){
    const h = new Date().getHours();
    if (h < 4)  return pick(timeGreetings.nightLate);
    if (h < 11) return pick(timeGreetings.morning);
    if (h < 15) return pick(timeGreetings.noon);
    if (h < 19) return pick(timeGreetings.evening);
    return pick(timeGreetings.night);
  }
  function randomLine(){ setBubble(pick(baseLines)); }

  // 初期
  sync();
  setBubble(localStorage.getItem('lover_first_seen') ? timeGreeting() : "……おや、すみません。待たせてしまいましたね。");
  localStorage.setItem('lover_first_seen','1');

  // クリック/ボタン
  $('char').addEventListener('click', randomLine);
  $('btn-rand').addEventListener('click', randomLine);
  $('btn-greet').addEventListener('click', ()=>setBubble(timeGreeting()));
  $('btn-mood').addEventListener('click', ()=>{ state.mood=!state.mood; sync(); setBubble(state.mood?"……そんなに見つめられると、困りますよ。":"では、少しだけ真面目に。"); });

  async function toggleFS(){ try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
      if (screen.orientation && screen.orientation.lock) { try{ await screen.orientation.lock('portrait'); }catch(e){} }
    }else{ await document.exitFullscreen(); }
  }catch(e){ setBubble("全画面はこの環境で制限されています。ホーム追加もお試しを。"); } }
  $('btn-full').addEventListener('click', toggleFS);

  const btnSettings=$('settings-btn'), menu=$('settings-menu');
  btnSettings.addEventListener('click', ()=>{
    menu.style.display = (menu.style.display==='block') ? 'none' : 'block';
  });
  document.addEventListener('click', (e)=>{
    if(!menu.contains(e.target) && e.target!==btnSettings){ menu.style.display='none'; }
  });
  $('menu-full').addEventListener('click', toggleFS);
  $('menu-ui').addEventListener('click', ()=>{ $('toolbar').classList.toggle('hidden'); });
  $('menu-reload').addEventListener('click', ()=>location.reload());
})();
</script>
</body>
</html>
