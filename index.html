<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>紫煙くゆる生物室</title>
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f12">
<style>
  :root { --bg:#0f0f12; --fg:#e8e8ee; --muted:#9aa0a6; --accent:#bca0ff; --card:#17171b; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic UI","Yu Gothic","Meiryo",sans-serif;
            height:100%;min-height:100dvh;overflow:hidden;}

  .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden;
         background:linear-gradient(180deg,#13131a,#0b0b0e);}
  .t-late  { background:radial-gradient(1200px 600px at 50% -10%,#27223a 0%,#121218 60%,#0a0a0d 100%); }
  .t-morn  { background:radial-gradient(1200px 600px at 50% -10%,#f1f4ff 0%,#dfe8ff 40%,#c8d4ff 60%,#aeb8ff 75%,#5860a0 100%); }
  .t-noon  { background:linear-gradient(180deg,#dfe9ff,#bcd4ff 50%,#8aa4ff); }
  .t-eve   { background:radial-gradient(1000px 520px at 50% -10%,#ffd7e0 0%,#c39ad3 40%,#6e68a6 70%,#2b2a46 100%); }
  .t-night { background:radial-gradient(1000px 520px at 50% -10%,#1a1f35 0%,#101425 55%,#0b0e18 100%); }

  /* 彼をさらに大きく・高画質表示 */
  .char {
    position:relative;
    width:min(110vw,1200px);
    max-height:100vh;
    aspect-ratio:3/5;
    border-radius:16px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#0c0c0f;
    transform:scale(1.5);
    transform-origin:center bottom;
    box-shadow:0 18px 54px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05);
  }
  .layer {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain;
    pointer-events:none;
    image-rendering:-webkit-optimize-contrast;
    transform:translateZ(0);
    opacity:0;
    transition:opacity .6s ease;
  }
  .layer.loaded { opacity:1; }

  /* セリフボックス位置（太ももに重なる） */
  .overlay { position:absolute; left:50%; bottom:2.8vh; transform:translateX(-50%);
             width:min(96vw,980px); max-width:980px; pointer-events:none; }
  .bubble { pointer-events:auto;
            color:var(--fg); font-size:16px; line-height:1.75; letter-spacing:.2px;
            background:rgba(20,20,26,.72); border:1px solid rgba(255,255,255,.12);
            border-radius:14px; padding:12px 14px; backdrop-filter:blur(8px);
            transition:opacity .2s ease; }
  .bubble.hidebox { background:transparent; border-color:transparent; backdrop-filter:none; }
  .overlay.hidden { display:none; }

  .settings-btn{position:fixed;right:14px;bottom:14px;width:52px;height:52px;border-radius:50%;
                display:flex;align-items:center;justify-content:center;font-size:24px;background:rgba(0,0,0,.6);
                border:1px solid rgba(255,255,255,.12);box-shadow:0 12px 28px rgba(0,0,0,.45); z-index:10;}
  .settings-menu{position:fixed;right:14px;bottom:74px;min-width:220px;background:rgba(18,18,22,.96);
                 border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;display:none; z-index:10;}
  .settings-menu .item{display:block;width:100%;text-align:left;border:none;background:transparent;
                       padding:10px;border-radius:8px;font-size:14px;color:var(--fg)}
  .settings-menu .item:hover{background:rgba(255,255,255,.06)}
</style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="char" id="char" title="タップで話す">
      <img id="img-base"  class="layer" alt="base"  src="base.png" loading="eager"/>
      <img id="img-smile" class="layer" alt="smile" src="smile.png" style="display:none" loading="eager"/>
    </div>
    <div class="overlay" id="overlay">
      <div class="bubble" id="bubble"><span id="bubbleText">……おや、来てくれたのですね。</span></div>
    </div>
  </div>

  <button class="settings-btn" id="settings-btn" aria-label="設定">⚙</button>
  <div class="settings-menu" id="settings-menu">
    <button class="item" id="menu-text">セリフ表示 ON/OFF（ボックス連動）</button>
    <button class="item" id="menu-box">セリフボックス表示 ON/OFF（枠のみ）</button>
    <button class="item" id="menu-reload">再読み込み</button>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const stage=$('stage'), char=$('char'), imgSmile=$('img-smile');
  const overlay=$('overlay'), bubble=$('bubble'), bubbleText=$('bubbleText');

  // === フェードイン（画像ロード時に.loaded付与）
  document.querySelectorAll('.layer').forEach(img=>{
    img.addEventListener('load',()=>img.classList.add('loaded'));
  });

  // === 背景時間連動 ===
  function clsSwap(el,names){names.forEach(n=>el.classList.remove(n));}
  function setBackdropByTime(){
    const h=new Date().getHours();
    clsSwap(stage,['t-late','t-morn','t-noon','t-eve','t-night']);
    if(h<4)stage.classList.add('t-late');
    else if(h<11)stage.classList.add('t-morn');
    else if(h<15)stage.classList.add('t-noon');
    else if(h<19)stage.classList.add('t-eve');
    else stage.classList.add('t-night');
  }
  setBackdropByTime(); setInterval(setBackdropByTime,60000);

  // === セリフ ===
  function pick(a){return a[Math.floor(Math.random()*a.length)];}
  const timeGreetings={ nightLate:["まだ起きているのですか……ええ、実は私もです。","夜更けに呼吸を合わせると、不思議と落ち着きますね。"],
    morning:["おはようございます。朝の光は、体内時計の薬です。","あなたは朝から元気ですね。……素晴らしいことです。ええ、ずっと見守っていたいです。","……おや。睡眠不足ですか？ 私も人のことを言えませんがね。"],
    noon:["午後の光は気怠いですね……少し肩の力を抜きましょう。","午前中頑張りましたね。一服しましょう。","お昼は食べましたか。眠たいのなら、少しだけ陽を浴びてください。","姉さん……桃は魅力的なひとでしょう。それに比べ、あなたがなぜ私のところへ来るのかわかりかねますが……ふふ。うれしいですよ。","仕事……いいんですよ。あなたのためなら私はいくらでも時間を作ります。"],
    evening:["こんにちは。……肩に力が入りすぎていませんか。私と一緒にゆっくり呼吸をしましょう……。","おやつ、食べますか？ チョコミントアイス……お好きなら、半分こしましょう。","空の色が変わる時間……あなたと見るのが好きです。","あなたは頑張り屋さんなんですから、自覚して休憩しないといけませんよ……。必要なら、私がお茶を淹れます。"],
    night:["夜風にあたりながら遠い空をぼうっと見つめると……一日のざわめきも死んだように静まります。","あの……今夜、眠る前にすこし撫でていただけませんか。……そうしたら、眠れる気がします。","お疲れ様です。家に帰ったら、あなたはもう安心していいのですよ。私がついていますから……。","こんばんは。今日もよく来ましたね。どうぞ一息ついてください。"]};
  const baseLines=["……おや、来てくれたのですね。","待たせてしまいましたね。","静かな夜です。あなたも、息をひとつ。","目を閉じて。……大丈夫、ここにいます。","……寒くありませんか。冷えないよう、ひざ掛けを。","ふふ、そんな顔をするのですね。……可愛らしい。","呼吸を整えて。—はい、今ので少し楽になったでしょう。"];
  function timeGreeting(){const h=new Date().getHours();
    if(h<4)return pick(timeGreetings.nightLate);
    if(h<11)return pick(timeGreetings.morning);
    if(h<15)return pick(timeGreetings.noon);
    if(h<19)return pick(timeGreetings.evening);
    return pick(timeGreetings.night);}
  function randomBase(){return pick(baseLines);}
  function speak(){
    const line=(Math.random()<0.5)?timeGreeting():randomBase();
    bubbleText.textContent=line;
    const mood=Math.random()<0.4;
    imgSmile.style.display=mood&&imgSmile.getAttribute('src')?'block':'none';
  }

  bubbleText.textContent=localStorage.getItem('lover_first_seen')?timeGreeting():"……おや、すみません。待たせてしまいましたね。";
  localStorage.setItem('lover_first_seen','1');
  $('char').addEventListener('click',speak);
  stage.addEventListener('click',e=>{if(e.target===stage)speak();});

  // === 歯車 ===
  const btnSettings=$('settings-btn'),menu=$('settings-menu');
  btnSettings.addEventListener('click',e=>{
    e.stopPropagation();
    menu.style.display=(menu.style.display==='block')?'none':'block';
  });
  document.addEventListener('click',()=>{menu.style.display='none';});

  $('menu-text').addEventListener('click',()=>{
    const hidden=overlay.classList.toggle('hidden');
    if(hidden) bubble.classList.add('hidebox');
  });
  $('menu-box').addEventListener('click',()=>{
    if(overlay.classList.contains('hidden')) overlay.classList.remove('hidden');
    bubble.classList.toggle('hidebox');
  });
  $('menu-reload').addEventListener('click',()=>location.reload());
})();
</script>
</body>
</html>
